name: elk-pipeline

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ELASTIC_VERSION: ${{ secrets.ELASTIC_VERSION }}
      ELASTIC_PASSWORD: ${{ secrets.ELASTIC_PASSWORD }}
      LOGSTASH_INTERNAL_PASSWORD: ${{ secrets.LOGSTASH_INTERNAL_PASSWORD }}
      KIBANA_SYSTEM_PASSWORD: ${{ secrets.KIBANA_SYSTEM_PASSWORD }}
      FILEBEAT_INTERNAL_PASSWORD: ${{ secrets.FILEBEAT_INTERNAL_PASSWORD }}
      BEATS_SYSTEM_PASSWORD: ${{ secrets.BEATS_SYSTEM_PASSWORD }}

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. SSHë¥¼ í†µí•´ EC2ì— ì ‘ì†í•˜ì—¬ ë ˆí¬ì§€í† ë¦¬ í´ë¡  ë° ë°°í¬
      - name: Clone and Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ELK_EC2_HOST }}
          username: ${{ secrets.ELK_EC2_USER }}
          key: ${{ secrets.ELK_EC2_SSH_KEY }}
          
          script: |
            # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed. Installing now..."
              sudo apt-get update
              sudo apt-get install -y docker.io
              echo "Docker installed successfully."
            else
              echo "Docker is already installed."
            fi

            # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose is not installed. Installing now..."
              sudo apt-get install -y docker-compose-plugin
              echo "Docker Compose installed successfully."
            else
              echo "Docker Compose is already installed."
            fi
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì´ë™ ë° ì¤€ë¹„
            if [ ! -d "/home/ubuntu/FinalProjectCloud" ]; then
              mkdir -p /home/ubuntu/FinalProjectCloud
            fi
            cd /home/ubuntu/FinalProjectCloud

            # ë ˆí¬ì§€í† ë¦¬ í´ë¡  ë˜ëŠ” ì—…ë°ì´íŠ¸
            if [ ! -d ".git" ]; then
              git clone --branch dev https://github.com/KTB16Team/FinalProjectCloud.git .
            else
              git reset --hard
              git clean -fd
              git pull origin dev
            fi

            # Docker Compose ì‹¤í–‰ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd monitoring/elk-stack

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker compose down

            # Docker Composeë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker compose --profile=setup up setup && docker compose up -d

  # 3. í—¬ìŠ¤ ì²´í¬ - ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Health Check Container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ELK_EC2_HOST }}
          username: ${{ secrets.ELK_EC2_USER }}
          key: ${{ secrets.ELK_EC2_SSH_KEY }}
          script: |
            # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ì‹œê°„ì„ ê¸°ë‹¤ë¦¼
            sleep 20

            # Elasticsearch ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬
            if ! curl -s -f http://localhost:9200/_cluster/health; then
              echo "Error: Elasticsearch is not healthy or not responding."
              exit 1
            fi

            # Kibana ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ ì²´í¬
            if ! curl -s -f http://localhost:5601/api/status; then
              echo "Error: Kibana is not healthy or not responding."
              exit 1
            fi

            echo "All services are running and healthy!"

  # 4. ë””ìŠ¤ì½”ë“œ ì•Œë¦¼
  notify:
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    steps:
      - name: Notify Discord of Build and Deployment Result
        run: |
          # GitHub Actions ë§í¬ ìƒì„±
          ACTIONS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # í•œêµ­ ì‹œê°„ ìƒì„±
          TIMESTAMP=$(TZ='Asia/Seoul' date +'%p %I:%M' | sed 's/AM/ì˜¤ì „/g; s/PM/ì˜¤í›„/g')

          # ì„±ê³µ ì—¬ë¶€ í™•ì¸
          if [[ "${{ needs.deploy.result }}" == "success" && "${{ needs.health-check.result }}" == "success" ]]; then
            # ì„±ê³µ Embed ë©”ì‹œì§€
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âœ… ELK Stack ë°°í¬ ì™„ë£Œ",
                  "description": "ì•„ì‹¸! ë°°í¬ ì„±ê³µ! ğŸ‰",
                  "color": 3066993,
                  "fields": [
                    { "name": "Deploy ê²°ê³¼", "value": "'"${{ needs.deploy.result }}"'", "inline": true },
                    { "name": "Health Check ê²°ê³¼", "value": "'"${{ needs.health-check.result }}"'", "inline": true }
                  ],
                  "footer": {
                    "text": "ELK Stack CI/CD ì™„ë£Œ - '"$TIMESTAMP"'"
                  }
                }]
              }' \
              https://discord.com/api/webhooks/1308680306341056574/Rept3YTMArv_h_0QFWJBo9x1sZhQokwl1S3I7P9Rj_OykBzsj1MtHz6ww4Uimo38plnG
          else
            # ì‹¤íŒ¨ Embed ë©”ì‹œì§€
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âŒ ELK Stack CI/CD ì‹¤íŒ¨",
                  "description": "í—‰ ë ˆì „ë“œ ì‚¬ê±´ ë°œìƒ!! [ë¡œê·¸ í™•ì¸í•˜ê¸°]('"$ACTIONS_URL"')",
                  "color": 15158332,
                  "fields": [
                    { "name": "Deploy ê²°ê³¼", "value": "'"${{ needs.deploy.result }}"'", "inline": true },
                    { "name": "Health Check ê²°ê³¼", "value": "'"${{ needs.health-check.result }}"'", "inline": true }
                  ],
                  "footer": {
                    "text": "ELK Stack CI/CD ì‹¤íŒ¨ - '"$TIMESTAMP"'"
                  }
                }]
              }' \
              https://discord.com/api/webhooks/1308680306341056574/Rept3YTMArv_h_0QFWJBo9x1sZhQokwl1S3I7P9Rj_OykBzsj1MtHz6ww4Uimo38plnG
